<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Upload Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status.running {
            background: #10b981;
            color: white;
        }
        
        .status.stopped {
            background: #ef4444;
            color: white;
        }
        
        .control-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-start {
            background: #10b981;
            color: white;
        }
        
        .btn-start:hover {
            background: #059669;
        }
        
        .btn-start:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-stop {
            background: #ef4444;
            color: white;
        }
        
        .btn-stop:hover {
            background: #dc2626;
        }
        
        .btn-stop:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-clear {
            background: #6366f1;
            color: white;
        }
        
        .btn-clear:hover {
            background: #4f46e5;
        }
        
        .log-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .log-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-panel::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }
        
        .log-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }
        
        .log-panel::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            word-wrap: break-word;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #6366f1;
        }
        
        .info-box strong {
            color: #6366f1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Auto Upload Control</h1>
            <div id="status" class="status stopped">ƒêang d·ª´ng</div>
        </div>
        
        <div class="control-panel">
            <div class="buttons">
                <button id="btnStart" class="btn-start" onclick="startScript()">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu</button>
                <button id="btnStop" class="btn-stop" onclick="stopScript()" disabled>‚èπÔ∏è D·ª´ng</button>
                <button id="btnProcess" class="btn-clear" onclick="processDefault()">üßæ X·ª≠ l√Ω h√≥a ƒë∆°n (SBPM)</button>
                <button id="btnGrab" class="btn-clear" onclick="createGrab()">üè™ T·∫°o h√≥a ƒë∆°n Grab</button>
                <button id="btnClearLogs" class="btn-clear" onclick="clearLogs()">üóëÔ∏è X√≥a logs</button>
                <button id="btnClearFiles" class="btn-stop" onclick="clearFiles()">üóëÔ∏è X√≥a files ƒë√£ t·∫°o</button>
            </div>
            
            <div class="info-box" id="infoBox" style="margin-top: 20px;">
                <strong>Th√¥ng tin:</strong> Script s·∫Ω t·ª± ƒë·ªông upload c√°c file trong th∆∞ m·ª•c <code>tax_files</code>
            </div>
        </div>
        
        <div class="log-panel" id="logPanel">
            <div class="log-entry">Ch·ªù l·ªánh...</div>
        </div>
    </div>
    
    <script>
        let statusInterval = null;
        let logInterval = null;

        function startPolling() {
            if (!statusInterval) {
                statusInterval = setInterval(updateStatus, 1000);
            }
            if (!logInterval) {
                logInterval = setInterval(updateLogs, 500);
            }
            // Update immediately when starting
            updateStatus();
            updateLogs();
        }

        function stopPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
        }
        
        // Ki·ªÉm tra status m·ªói 1 gi√¢y
        function updateStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    const statusEl = document.getElementById('status');
                    const btnStart = document.getElementById('btnStart');
                    const btnStop = document.getElementById('btnStop');
                    
                    if (data.running) {
                        statusEl.textContent = 'ƒêang ch·∫°y';
                        statusEl.className = 'status running';
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        // Ensure polling is active when running
                        if (!statusInterval || !logInterval) {
                            startPolling();
                        }
                    } else {
                        statusEl.textContent = 'ƒêang d·ª´ng';
                        statusEl.className = 'status stopped';
                        btnStart.disabled = false;
                        btnStop.disabled = true;
                        // Stop polling when not running
                        stopPolling();
                    }
                })
                .catch(err => console.error('Error updating status:', err));
        }
        
        // C·∫≠p nh·∫≠t logs m·ªói 0.5 gi√¢y
        function updateLogs() {
            fetch('/api/logs')
                .then(res => res.json())
                .then(data => {
                    const logPanel = document.getElementById('logPanel');
                    if (data.logs && data.logs.length > 0) {
                        logPanel.innerHTML = data.logs.map(log => 
                            `<div class="log-entry">${escapeHtml(log)}</div>`
                        ).join('');
                        // Auto scroll to bottom
                        logPanel.scrollTop = logPanel.scrollHeight;
                    }
                })
                .catch(err => console.error('Error updating logs:', err));
        }
        
        function startScript() {
            fetch('/api/start', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Script ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông!');
                        startPolling();
                    } else {
                        alert('‚ùå L·ªói: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('‚ùå L·ªói k·∫øt n·ªëi: ' + err.message);
                });
        }
        
        function stopScript() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng script?')) {
                return;
            }
            
            fetch('/api/stop', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Script ƒë√£ ƒë∆∞·ª£c d·ª´ng!');
                        stopPolling();
                    } else {
                        alert('‚ùå L·ªói: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('‚ùå L·ªói k·∫øt n·ªëi: ' + err.message);
                });
        }
        
        function clearLogs() {
            fetch('/api/clear-logs', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('logPanel').innerHTML = '<div class="log-entry">Logs ƒë√£ ƒë∆∞·ª£c x√≥a</div>';
                    }
                })
                .catch(err => {
                    alert('‚ùå L·ªói: ' + err.message);
                });
        }
        
        function clearFiles() {
            if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ files .xlsx trong tax_files/?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }
            
            const btn = document.getElementById('btnClearFiles');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang x√≥a...';
            
            fetch('/api/clear-files', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const logPanel = document.getElementById('logPanel');
                    if (data.success) {
                        const filesList = (data.files || []).map(f => `- ${f}`).join('\n');
                        const message = `‚úÖ ƒê√£ x√≥a ${data.deleted_count} file(s):\n${filesList}`;
                        logPanel.innerHTML = `<div class="log-entry">${escapeHtml(message)}</div>`;
                        logPanel.scrollTop = logPanel.scrollHeight;
                        alert(`‚úÖ ƒê√£ x√≥a ${data.deleted_count} file(s) trong tax_files/`);
                    } else {
                        logPanel.innerHTML = `<div class="log-entry">‚ùå L·ªói: ${escapeHtml(data.error || 'Unknown error')}</div>`;
                        alert('‚ùå L·ªói: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('‚ùå L·ªói k·∫øt n·ªëi: ' + err.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è X√≥a files ƒë√£ t·∫°o';
                });
        }
        
        function processDefault() {
            const btn = document.getElementById('btnProcess');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
            fetch('/api/process-default', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const logPanel = document.getElementById('logPanel');
                    if (data.success) {
                        const files = (data.files || []).map(f => `- ${f}`).join('\n');
                        const msg = `‚úÖ ƒê√£ t·∫°o ${data.created} file trong tax_files\n${files}`;
                        const logs = (data.logs || []).join('\n');
                        logPanel.innerHTML = `<div class="log-entry">${escapeHtml(msg)}</div>` +
                          (logs ? `<div class="log-entry">${escapeHtml(logs)}</div>` : '');
                    } else {
                        logPanel.innerHTML = `<div class=\"log-entry\">‚ùå L·ªói: ${escapeHtml(data.error || 'Unknown')}</div>`;
                    }
                    logPanel.scrollTop = logPanel.scrollHeight;
                })
                .catch(err => {
                    alert('‚ùå L·ªói x·ª≠ l√Ω: ' + err.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'üßæ X·ª≠ l√Ω h√≥a ƒë∆°n (SBPM)';
                });
        }

        function createGrab() {
            const menu = prompt("Nh·∫≠p nh√† h√†ng (simple/taco):", "simple");
            if (!menu) return;
            const total = prompt("Nh·∫≠p t·ªïng ti·ªÅn (ƒë√£ g·ªìm VAT 8%):", "1080000");
            if (!total) return;
            const date = prompt("Nh·∫≠p ng√†y (DD/MM/YYYY) ho·∫∑c b·ªè tr·ªëng:", "");
            const inv = prompt("Nh·∫≠p s·ªë h√≥a ƒë∆°n (t√πy ch·ªçn) ho·∫∑c b·ªè tr·ªëng:", "");
            
            const btn = document.getElementById('btnGrab');
            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang t·∫°o...';
            
            fetch('/api/grab-invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ menu, total_with_tax: total, date, invoice_number: inv })
            })
            .then(res => res.json())
            .then(data => {
                const logPanel = document.getElementById('logPanel');
                if (data.success) {
                    const files = (data.files || []).map(f => `- ${f}`).join('\n');
                    const msg = `‚úÖ ƒê√£ t·∫°o h√≥a ƒë∆°n Grab (${data.menu}).\nFile: ${data.output}\nT·ªïng files m·ªõi: ${data.created_count}\n${files}`;
                    logPanel.innerHTML = `<div class=\"log-entry\">${escapeHtml(msg)}</div>`;
                    logPanel.scrollTop = logPanel.scrollHeight;
                    alert('‚úÖ ƒê√£ t·∫°o h√≥a ƒë∆°n Grab!');
                } else {
                    logPanel.innerHTML = `<div class=\"log-entry\">‚ùå L·ªói: ${escapeHtml(data.error || 'Unknown')}</div>`;
                    alert('‚ùå L·ªói: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'üè™ T·∫°o h√≥a ƒë∆°n Grab';
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Kh√¥ng polling m·∫∑c ƒë·ªãnh. Polling ch·ªâ b·∫≠t khi script ƒëang ch·∫°y ho·∫∑c sau khi ·∫•n B·∫Øt ƒë·∫ßu.
    </script>
</body>
</html>
